# Система шифрования для SECURE_KEY

## Обзор

Добавлен функционал шифрования для SECURE_KEY в payload запросов. Теперь вместо передачи открытого ключа используется SHA-256 хеширование для обеспечения безопасности.

## Что изменилось

### 1. Серверная часть (functions/index.js)

- Добавлены импорты для криптографии: `crypto-js` и `node-rsa`
- Реализована функция `generateSHA256Hash()` для создания хешей
- Добавлена функция `verifyEncryptedKey()` для проверки зашифрованных ключей
- Обновлена логика проверки в функции `getPassport()`
- Добавлена новая функция `generateSecureKey()` для клиентской стороны

### 2. Клиентская часть

- Создан файл `src/lib/cryptoUtils.ts` с утилитами для шифрования
- Создан файл `src/lib/cryptoExamples.ts` с примерами использования
- Обновлен `src/lib/firebase.ts` для использования зашифрованных ключей
- Обновлен `src/lib/utils.ts` для экспорта криптографических функций

## Как это работает

### Процесс шифрования:

1. **Клиентская сторона**: Оригинальный ключ хешируется с помощью SHA-256
2. **Отправка**: В payload отправляется хеш вместо открытого ключа
3. **Серверная сторона**: Полученный хеш сравнивается с хешем от SECURE_KEY из переменных окружения
4. **Проверка**: Если хеши совпадают, доступ разрешается

### Пример payload:

**До (небезопасно):**

```json
{
  "id": "passport-front/file.png",
  "key": "terrarentcar-secure-2024"
}
```

**После (безопасно):**

```json
{
  "id": "passport-front/file.png",
  "key": "a1b2c3d4e5f6... (SHA-256 хеш)"
}
```

## Использование

### Базовые функции:

```typescript
import {
  generateSHA256Hash,
  verifyHash,
  createSecurePayload,
} from "./lib/cryptoUtils";

// Генерация хеша
const hash = generateSHA256Hash("terrarentcar-secure-2024");

// Проверка хеша
const isValid = verifyHash(hash, "terrarentcar-secure-2024");

// Создание безопасного payload
const payload = createSecurePayload("file-id", "original-key");
```

### Автоматическое использование:

Функция `getFileURL()` в `firebase.ts` автоматически использует зашифрованные ключи:

```typescript
// Ключ автоматически шифруется перед отправкой
const url = await getFileURL("passport-front/file.png");
```

### Примеры:

```typescript
import { runAllExamples } from "./lib/cryptoExamples";

// Запуск всех примеров
runAllExamples();
```

## Безопасность

- **SHA-256**: Используется криптографически стойкий алгоритм хеширования
- **Одностороннее шифрование**: Хеш нельзя расшифровать обратно в оригинальный ключ
- **Переменные окружения**: SECURE_KEY хранится только на сервере
- **Проверка на сервере**: Все проверки происходят на серверной стороне

## Зависимости

### Серверная часть:

- `crypto-js` - для SHA-256 хеширования
- `node-rsa` - для RSA шифрования (готово к использованию)

### Клиентская часть:

- `crypto-js` - для SHA-256 хеширования
- `@types/crypto-js` - типы для TypeScript

## Развертывание

1. Убедитесь, что переменная окружения `SECURE_KEY` установлена на сервере
2. Перезапустите Firebase Functions
3. Обновите клиентскую часть (если необходимо)

## Тестирование

Для тестирования можно использовать функции из `cryptoExamples.ts`:

```typescript
import { exampleSecurePayload } from "./lib/cryptoExamples";

// Тестирование создания безопасного payload
const payload = exampleSecurePayload();
console.log(payload);
```

## Совместимость

- ✅ Существующий код не изменен
- ✅ Добавлен новый функционал
- ✅ Обратная совместимость сохранена
- ✅ Все существующие импорты и структура файлов сохранены
